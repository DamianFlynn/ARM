{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Name for the resouce in template format, eg bm-demo-{resourceType}-Test-ne"
      }
    },
    "vmSettings": {
      "type": "object"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "contactEmail": {
      "type": "string",
      "defaultValue": "damian.flynn@innofactor.com"
    },
    "environment": {
      "type": "string",
      "allowedValues": [
        "Prod",
        "Test",
        "Dev",
        "POC"
      ],
      "defaultValue": "Dev",
      "metadata": {
        "description": "Type of environment"
      }
    }
  },
  "variables": {
    "vmName": "[replace(parameters('name'),'{resourceType}','vm')]",
    "acceleratedSKU": ["Standard_D12_v2", "Standard_D3_v2_Promo", "Standard_D12_v2_Promo", "Standard_DS3_v2", "Standard_DS12_v2", "Standard_DS13-4_v2", "Standard_DS14-4_v2", "Standard_DS3_v2_Promo", "Standard_DS12_v2_Promo", "Standard_DS13-4_v2_Promo", "Standard_DS14-4_v2_Promo", "Standard_F4", "Standard_F4s", "Standard_D8_v3", "Standard_D8s_v3", "Standard_D32-8s_v3", "Standard_E8_v3", "Standard_E8s_v3", "Standard_D3_v2_ABC", "Standard_D12_v2_ABC", "Standard_F4_ABC", "Standard_F8s_v2", "Standard_D4_v2", "Standard_D13_v2", "Standard_D4_v2_Promo", "Standard_D13_v2_Promo", "Standard_DS4_v2", "Standard_DS13_v2", "Standard_DS14-8_v2", "Standard_DS4_v2_Promo", "Standard_DS13_v2_Promo", "Standard_DS14-8_v2_Promo", "Standard_F8", "Standard_F8s", "Standard_M64-16ms", "Standard_D16_v3", "Standard_D16s_v3", "Standard_D32-16s_v3", "Standard_D64-16s_v3", "Standard_E16_v3", "Standard_E16s_v3", "Standard_E32-16s_v3", "Standard_D4_v2_ABC", "Standard_D13_v2_ABC", "Standard_F8_ABC", "Standard_F16s_v2", "Standard_D5_v2", "Standard_D14_v2", "Standard_D5_v2_Promo", "Standard_D14_v2_Promo", "Standard_DS5_v2", "Standard_DS14_v2", "Standard_DS5_v2_Promo", "Standard_DS14_v2_Promo", "Standard_F16", "Standard_F16s", "Standard_M64-32ms", "Standard_M128-32ms", "Standard_D32_v3", "Standard_D32s_v3", "Standard_D64-32s_v3", "Standard_E32_v3", "Standard_E32s_v3", "Standard_E32-8s_v3", "Standard_E32-16_v3", "Standard_D5_v2_ABC", "Standard_D14_v2_ABC", "Standard_F16_ABC", "Standard_F32s_v2", "Standard_D15_v2", "Standard_D15_v2_Promo", "Standard_D15_v2_Nested", "Standard_DS15_v2", "Standard_DS15_v2_Promo", "Standard_DS15_v2_Nested", "Standard_D40_v3", "Standard_D40s_v3", "Standard_D15_v2_ABC", "Standard_M64ms", "Standard_M64s", "Standard_M128-64ms", "Standard_D64_v3", "Standard_D64s_v3", "Standard_E64_v3", "Standard_E64s_v3", "Standard_E64-16s_v3", "Standard_E64-32s_v3", "Standard_F64s_v2", "Standard_F72s_v2", "Standard_M128s", "Standard_M128ms", "Standard_L8s_v2", "Standard_L16s_v2", "Standard_L32s_v2", "Standard_L64s_v2", "SQLGL", "SQLGLCore", "Standard_D4_v3", "Standard_D4s_v3", "Standard_D2_v2", "Standard_DS2_v2", "Standard_E4_v3", "Standard_E4s_v3", "Standard_F2", "Standard_F2s", "Standard_F4s_v2", "Standard_D11_v2", "Standard_DS11_v2", "AZAP_Performance_ComputeV17C", "AZAP_Performance_ComputeV17C_DDA", "Standard_PB6s", "Standard_PB12s", "Standard_PB24s", "Standard_L80s_v2", "Standard_M8ms", "Standard_M8-4ms", "Standard_M8-2ms", "Standard_M16ms", "Standard_M16-8ms", "Standard_M16-4ms", "Standard_M32ms", "Standard_M32-8ms", "Standard_M32-16ms", "Standard_M32ls", "Standard_M32ts", "Standard_M64ls", "Standard_E64i_v3", "Standard_E64is_v3", "Standard_E4-2s_v3", "Standard_E8-4s_v3", "Standard_E8-2s_v3", "Standard_E16-4s_v3", "Standard_E16-8s_v3", "Standard_E20s_v3", "Standard_E20_v3", "Standard_D11_v2_Promo", "Standard_D2_v2_Promo", "Standard_DS11_v2_Promo", "Standard_DS2_v2_Promo", "Standard_M208ms_v2", "Standard_MDB16s", "Standard_MDB32s", "Experimental_E64-40s_v3", "Standard_DS11-1_v2", "Standard_DS12-1_v2", "Standard_DS12-2_v2", "Standard_DS13-2_v2"],
    "publicIPAddress": "[ if( or equals(parameters('NetworkInterfaceType'),'Standard_D3_v2'), greater(parameters('PIPCount'),0)  ),  resourceId('Microsoft.Network/publicIPAddresses',Concat(variables('NICName'),'-pip')), json('null') ) ]"
  },
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "apiVersion": "2018-06-01",
      "location": "[parameters('location')]",
      "scale": null,
      "dependsOn": [],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSettings').vm_size]"
        },
        "osProfile": {
          "computerName": "[variables('vmName')]",
          "adminUsername": "[parameters('vmSettings').os_profile.admin_username]",
          "adminPassword": "[parameters('vmSettings').os_profile.admin_password]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('vmSettings').storage_image_reference.publisher]",
            "offer": "[parameters('vmSettings').storage_image_reference.offer]",
            "sku": "[parameters('vmSettings').storage_image_reference.sku]",
            "version": "[parameters('vmSettings').storage_image_reference.version]"
          },
          "osDisk": {
            "osType": "Linux",
            "createOption": "FromImage",
            "name": "[concat(variables('vmName'),'.vhd')]",
            "caching": "ReadOnly",
            "diskSizeGB": 30
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[parameters('vmSettings').network_interface_id]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": true,
            "storageUri": "[concat(reference(parameters('vmSettings').diagStorage, '2016-01-01').primaryEndpoints.blob)]"
          }
        }
      }
    }
  ],
  "outputs": {
    "resourceID": {
      "type": "string",
      "value": "[resourceId('Microsoft.Compute/virtualMachines'", "variables('vmName'))]"
    }
  }
}